<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Diffusion WebUI 开发文档</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        code, pre {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 5px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 0.9em;
        }
        pre {
            padding: 10px;
            overflow-x: auto;
        }
        .note {
            background-color: #f0f7fb;
            border-left: 5px solid #3498db;
            padding: 15px;
            margin: 20px 0;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Stable Diffusion WebUI 开发文档</h1>
    <p>版本: 1.0 | 更新日期: 2024年11月</p>

    <h2>1. 项目概述</h2>
    <p>Stable Diffusion WebUI是一个基于Stable Diffusion的网页界面，允许用户通过友好的界面使用Stable Diffusion模型生成图像。项目的主要特点包括:</p>
    <ul>
        <li>直观的用户界面，支持文本到图像生成</li>
        <li>多种模型支持（SD 1.x, 2.x, SDXL等）</li>
        <li>各种增强功能，如ControlNet、LoRA等</li>
        <li>可扩展的插件系统</li>
    </ul>

    <h2>2. 环境配置</h2>
    <h3>2.1 系统要求</h3>
    <ul>
        <li>操作系统: Windows 10/11, Linux或macOS</li>
        <li>GPU: NVIDIA GPU (CUDA支持) 推荐6GB以上显存</li>
        <li>CPU: 支持AVX指令集</li>
        <li>内存: 最低8GB, 推荐16GB以上</li>
        <li>存储空间: 最低10GB, 推荐20GB以上</li>
    </ul>

    <h3>2.2 环境配置（Windows）</h3>
    <h4>2.2.1 使用脚本安装</h4>
    <p>使用以下PowerShell脚本可以自动化安装过程:</p>
    <pre><code># 以管理员权限运行
# 创建Python 3.10环境
conda create -n sd-webui python=3.10 -y
conda activate sd-webui

# 安装PyTorch和其他依赖
pip install torch==2.1.2+cu121 torchvision==0.16.2+cu121 --extra-index-url https://download.pytorch.org/whl/cu121

# 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 启动WebUI
python launch.py</code></pre>

    <h4>2.2.2 手动安装步骤</h4>
    <ol>
        <li>安装Python 3.10.6 (从<a href="https://www.python.org/downloads/release/python-3106/" target="_blank">官方网站</a>下载)</li>
        <li>安装Git</li>
        <li>克隆仓库：<code>git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git</code></li>
        <li>执行<code>webui-user.bat</code>脚本</li>
    </ol>

    <h3>2.3 环境配置（Linux）</h3>
    <pre><code># 安装依赖
sudo apt update
sudo apt install -y python3 python3-pip git

# 创建Python虚拟环境
python3 -m venv venv
source venv/bin/activate

# 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 启动WebUI
./webui.sh</code></pre>

    <h2>3. 项目结构</h2>
    <pre><code>stable-diffusion-webui/
├── extensions/         # 插件目录
├── models/             # 模型目录
│   ├── Stable-diffusion/   # SD模型
│   ├── Lora/           # LoRA模型
│   ├── VAE/            # VAE编码器
│   └── ControlNet/     # ControlNet模型
├── outputs/            # 生成图像输出目录
├── scripts/            # 辅助脚本
├── modules/            # 核心模块
├── webui.bat           # Windows启动脚本
├── webui.sh            # Linux/macOS启动脚本
└── launch.py           # 主启动脚本</code></pre>

    <h2>4. 接口和API</h2>
    <p>Stable Diffusion WebUI提供了REST API，使开发者能够以编程方式与系统交互。</p>

    <h3>4.1 启用API</h3>
    <p>使用<code>--api</code>参数启动WebUI以启用API功能:</p>
    <pre><code>python launch.py --api</code></pre>

    <h3>4.2 API示例</h3>
    <p>使用Python调用API生成图像:</p>
    <pre><code>import requests
import io
import base64
from PIL import Image

url = "http://127.0.0.1:7860/sdapi/v1/txt2img"

payload = {
    "prompt": "一只可爱的猫咪",
    "negative_prompt": "模糊, 低质量",
    "steps": 20,
    "width": 512,
    "height": 512
}

response = requests.post(url, json=payload)
r = response.json()

for i, img_data in enumerate(r['images']):
    image = Image.open(io.BytesIO(base64.b64decode(img_data)))
    image.save(f"output_image_{i}.png")</code></pre>

    <h2>5. 开发指南</h2>
    <h3>5.1 创建插件</h3>
    <p>Stable Diffusion WebUI支持插件系统，您可以创建自己的插件来扩展功能。</p>
    <p>插件目录结构:</p>
    <pre><code>my_extension/
├── scripts/            # Python脚本
│   └── my_script.py    # 主脚本文件
├── style.css           # 样式表
├── javascript.js       # JavaScript代码
└── install.py          # 安装脚本（可选）</code></pre>

    <p>示例插件脚本:</p>
    <pre><code>import modules.scripts as scripts
import gradio as gr

class MyExtensionScript(scripts.Script):
    def title(self):
        return "我的插件"

    def show(self, is_img2img):
        return scripts.AlwaysVisible

    def ui(self, is_img2img):
        with gr.Accordion("我的插件", open=False):
            my_slider = gr.Slider(minimum=0, maximum=10, step=0.1, label="参数", value=5)
        return [my_slider]

    def process(self, p, my_slider):
        print(f"使用参数值: {my_slider}")
        # 在这里实现你的功能
        return p</code></pre>

    <h3>5.2 配置与优化</h3>
    <p>WebUI启动参数：</p>
    <table>
        <tr>
            <th>参数</th>
            <th>说明</th>
        </tr>
        <tr>
            <td>--medvram</td>
            <td>使用中等VRAM优化</td>
        </tr>
        <tr>
            <td>--lowvram</td>
            <td>使用低VRAM优化</td>
        </tr>
        <tr>
            <td>--precision full</td>
            <td>使用全精度（浮点32）</td>
        </tr>
        <tr>
            <td>--api</td>
            <td>启用API</td>
        </tr>
        <tr>
            <td>--share</td>
            <td>通过Gradio共享界面</td>
        </tr>
    </table>

    <h2>6. 常见问题与解决方案</h2>
    <div class="note">
        <h3>Python版本问题</h3>
        <p>Stable Diffusion WebUI需要Python 3.10.x。如果使用不兼容的Python版本，请按照以下步骤操作:</p>
        <ol>
            <li>卸载当前Python或创建新的Conda环境</li>
            <li>安装Python 3.10.6</li>
            <li>删除项目中的venv文件夹</li>
            <li>重新启动WebUI</li>
        </ol>
    </div>

    <div class="warning">
        <h3>CUDA/PyTorch兼容性</h3>
        <p>如果遇到PyTorch安装问题，请确保选择与您的CUDA版本兼容的PyTorch版本:</p>
        <p>对于CUDA 12.x: <code>pip install torch==2.1.2+cu121 torchvision==0.16.2+cu121 --extra-index-url https://download.pytorch.org/whl/cu121</code></p>
        <p>对于CUDA 11.8: <code>pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118</code></p>
    </div>

    <h2>7. 资源与链接</h2>
    <ul>
        <li><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui" target="_blank">官方GitHub仓库</a></li>
        <li><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki" target="_blank">Wiki文档</a></li>
        <li><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions" target="_blank">讨论区</a></li>
        <li><a href="https://huggingface.co/models?pipeline_tag=text-to-image&sort=downloads" target="_blank">Hugging Face模型库</a></li>
        <li><a href="https://civitai.com/" target="_blank">Civitai社区模型</a></li>
    </ul>

    <footer>
        <p>© 2024 Stable Diffusion WebUI文档 | 本文档仅供参考，请以官方文档为准</p>
    </footer>
</body>
</html> 