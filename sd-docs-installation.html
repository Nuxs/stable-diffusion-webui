<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Diffusion WebUI - 安装指南</title>
    <link rel="stylesheet" href="sd-docs-style.css">
</head>
<body>
    <header>
        <h1>Stable Diffusion WebUI 开发文档</h1>
        <p>版本: 1.0 | 更新日期: 2024年11月</p>
        <nav>
            <ul>
                <li><a href="sd-docs-overview.html">项目概述</a></li>
                <li><a href="sd-docs-installation.html" class="active">安装指南</a></li>
                <li><a href="sd-docs-usage.html">使用指南</a></li>
                <li><a href="sd-docs-development.html">开发指南</a></li>
                <li><a href="sd-docs-api.html">API参考</a></li>
                <li><a href="sd-docs-troubleshooting.html">问题排查</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="windows-installation">
            <h2>1. Windows安装指南</h2>
            
            <h3>1.1 使用Conda环境（推荐）</h3>
            <p>使用Conda是管理Python环境的最佳方式，特别是在处理多个项目时，可以避免版本冲突。</p>
            
            <h4>1.1.1 安装Miniconda</h4>
            <ol>
                <li>从<a href="https://docs.conda.io/en/latest/miniconda.html" target="_blank">Miniconda官网</a>下载适合您Windows系统的安装程序</li>
                <li>运行安装程序，按照提示完成安装</li>
                <li>安装完成后，打开"Anaconda Prompt"或"Miniconda Prompt"</li>
            </ol>
            
            <h4>1.1.2 创建Python环境</h4>
            <pre><code>conda create -n sd-webui python=3.10 -y
conda activate sd-webui</code></pre>
            
            <h4>1.1.3 安装Git</h4>
            <p>如果您还没有安装Git，请从<a href="https://git-scm.com/download/win" target="_blank">Git官网</a>下载并安装。</p>
            
            <h4>1.1.4 克隆和启动WebUI</h4>
            <pre><code># 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 安装PyTorch (根据你的CUDA版本选择)
# 对于CUDA 12.x:
pip install torch==2.1.2+cu121 torchvision==0.16.2+cu121 --extra-index-url https://download.pytorch.org/whl/cu121

# 对于CUDA 11.8:
# pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118

# 启动WebUI
python launch.py</code></pre>
            
            <h3>1.2 使用自动安装脚本</h3>
            <p>您可以使用我们提供的PowerShell脚本自动完成安装过程：</p>
            
            <ol>
                <li>以管理员身份打开PowerShell</li>
                <li>设置执行策略：<code>Set-ExecutionPolicy Bypass -Scope Process -Force</code></li>
                <li>复制下面的脚本到一个名为<code>setup_stable_diffusion.ps1</code>的文件中</li>
                <li>运行脚本：<code>.\setup_stable_diffusion.ps1</code></li>
            </ol>
            
            <details>
                <summary>查看完整安装脚本</summary>
                <pre><code># Stable Diffusion WebUI Windows 11 安装脚本
# 请以管理员权限运行此脚本

# 设置执行策略
Set-ExecutionPolicy Bypass -Scope Process -Force

# 检查是否以管理员权限运行
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (-not $isAdmin) {
    Write-Host "请以管理员权限运行此脚本！" -ForegroundColor Red
    Exit
}

# 创建日志函数
function Write-Log {
    param($Message)
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message"
}

Write-Log "开始安装 Stable Diffusion WebUI 环境..."

# 首先检查并删除现有的venv目录
if (Test-Path "venv") {
    Write-Log "删除现有的Python虚拟环境..."
    Remove-Item -Recurse -Force "venv"
}

# 检查Python版本 - 需要确保安装3.10.6版本
$pythonInstalled = $false
$pythonCmd = $null

# 检查是否已安装Python 3.10
foreach ($testCmd in @("python3.10", "python3", "python")) {
    try {
        $version = & $testCmd -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>$null
        if ($version -eq "3.10") {
            $pythonInstalled = $true
            $pythonCmd = $testCmd
            Write-Log "找到兼容的Python版本: $testCmd ($version)"
            break
        }
    } catch {
        # 命令不存在或不是有效的Python，继续尝试下一个
    }
}

# 如果没有找到Python 3.10，则安装它
if (-not $pythonInstalled) {
    Write-Log "需要安装Python 3.10.6 (稳定版本)..."
    $pythonUrl = "https://www.python.org/ftp/python/3.10.6/python-3.10.6-amd64.exe"
    $pythonInstaller = "$env:TEMP\python-3.10.6-amd64.exe"
    
    Write-Log "下载Python 3.10.6..."
    Invoke-WebRequest -Uri $pythonUrl -OutFile $pythonInstaller
    
    Write-Log "安装Python 3.10.6 (这可能需要一些时间)..."
    # 安装Python，并将其添加到PATH中，但不注册为默认Python
    Start-Process -FilePath $pythonInstaller -ArgumentList "/quiet", "InstallAllUsers=1", "PrependPath=1", "Include_test=0" -Wait
    Remove-Item $pythonInstaller
    
    # 安装后确认Python安装路径
    $pythonCmd = "python"
    # 检查Python版本 - 为了确认安装成功
    try {
        $pythonVersion = & $pythonCmd --version
        Write-Log "已安装: $pythonVersion"
    } catch {
        Write-Log "警告: Python安装后无法验证版本。请确保Python 3.10.6已正确安装。"
    }
}

# 检查并安装 Git
Write-Log "检查 Git 安装..."
if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
    Write-Log "正在下载并安装 Git..."
    $gitUrl = "https://github.com/git-for-windows/git/releases/download/v2.41.0.windows.1/Git-2.41.0-64-bit.exe"
    $gitInstaller = "$env:TEMP\Git-2.41.0-64-bit.exe"
    Invoke-WebRequest -Uri $gitUrl -OutFile $gitInstaller
    Start-Process -FilePath $gitInstaller -ArgumentList "/VERYSILENT", "/NORESTART" -Wait
    Remove-Item $gitInstaller
}

# 检查是否已克隆仓库
if (-not (Test-Path "launch.py")) {
    Write-Log "正在克隆Stable Diffusion WebUI仓库..."
    git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git .
}

# 创建虚拟环境 - 使用Python 3.10
Write-Log "创建新的Python 3.10虚拟环境..."
& $pythonCmd -m venv venv

# 激活虚拟环境
Write-Log "激活虚拟环境..."
$activateScript = ".\venv\Scripts\activate.ps1"
if (Test-Path $activateScript) {
    . $activateScript
} else {
    Write-Log "错误: 找不到虚拟环境激活脚本。请手动激活环境。"
    Exit
}

# 安装依赖
Write-Log "安装Python依赖..."
python -m pip install --upgrade pip

# 安装特定版本的torch和torchvision
Write-Log "安装Pytorch (兼容版本)..."
pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118

# 安装其他依赖
if (Test-Path "requirements.txt") {
    Write-Log "安装requirements.txt中的依赖..."
    pip install -r requirements.txt
} else {
    Write-Log "警告: 找不到requirements.txt文件"
}

# 下载模型（可选，取决于用户需求）
Write-Log "创建模型目录..."
$modelDirs = @("models/Stable-diffusion", "models/VAE", "models/Lora", "models/ControlNet")
foreach ($dir in $modelDirs) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force
    }
}

Write-Log "环境配置完成！"
Write-Log "你现在可以通过运行 'webui.bat' 来启动 Stable Diffusion WebUI"

# 添加启动说明
Write-Host "`n=== 使用说明 ===" -ForegroundColor Green
Write-Host "1. 请确保已下载所需的模型文件并放置在相应目录中"
Write-Host "2. 运行 webui.bat 启动界面"
Write-Host "3. 首次启动可能需要一些时间来下载额外依赖"
Write-Host "4. 访问 http://localhost:7860 即可使用 WebUI"
Write-Host "==================`n"</code></pre>
            </details>
        </section>

        <section id="linux-installation">
            <h2>2. Linux安装指南</h2>
            
            <h3>2.1 Ubuntu/Debian系统</h3>
            <pre><code># 安装依赖
sudo apt update
sudo apt install -y python3 python3-pip python3-venv git

# 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 执行启动脚本
bash webui.sh</code></pre>
            
            <h3>2.2 Arch Linux</h3>
            <pre><code># 安装依赖
sudo pacman -Syu python python-pip git

# 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 执行启动脚本
bash webui.sh</code></pre>
            
            <div class="note">
                <p><strong>注意</strong>：在Linux系统上，<code>webui.sh</code>脚本会自动创建虚拟环境并安装所有依赖。</p>
            </div>
        </section>

        <section id="macos-installation">
            <h2>3. MacOS安装指南</h2>
            
            <h3>3.1 Intel处理器</h3>
            <pre><code># 安装Homebrew（如果尚未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装依赖
brew install python@3.10 git

# 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 执行启动脚本
bash webui.sh</code></pre>
            
            <h3>3.2 Apple Silicon (M1/M2/M3)</h3>
            <pre><code># 安装Homebrew（如果尚未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装依赖
brew install python@3.10 git cmake

# 克隆仓库
git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
cd stable-diffusion-webui

# 使用MPS加速（Metal性能着色器）
export COMMANDLINE_ARGS="--use-cpu all --skip-torch-cuda-test --no-half"

# 执行启动脚本
bash webui.sh</code></pre>
            
            <div class="warning">
                <p><strong>警告</strong>：Apple Silicon (M1/M2/M3) 性能可能不如NVIDIA GPU，某些功能可能受限或性能较低。</p>
            </div>
        </section>

        <section id="models-installation">
            <h2>4. 模型安装</h2>
            
            <h3>4.1 模型目录结构</h3>
            <p>模型文件应放置在以下目录中：</p>
            <pre><code>stable-diffusion-webui/
├── models/
│   ├── Stable-diffusion/   # 主要的SD模型 (.ckpt 或 .safetensors)
│   ├── VAE/                # VAE模型
│   ├── Lora/               # LoRA模型
│   ├── ControlNet/         # ControlNet模型
│   ├── hypernetworks/      # 超网络模型
│   ├── GFPGAN/             # 面部修复模型
│   ├── ESRGAN/             # 超分辨率模型
│   └── embeddings/         # 文本嵌入</code></pre>
            
            <h3>4.2 获取模型</h3>
            <p>您可以从以下来源获取模型：</p>
            <ul>
                <li><a href="https://huggingface.co/models?pipeline_tag=text-to-image&sort=downloads" target="_blank">HuggingFace</a> - 官方模型和社区模型</li>
                <li><a href="https://civitai.com/" target="_blank">Civitai</a> - 最大的社区模型分享平台</li>
                <li><a href="https://stable-diffusion-art.com/models/" target="_blank">Stable Diffusion Art</a> - 精选模型列表</li>
            </ul>
            
            <h3>4.3 推荐基础模型</h3>
            <table>
                <tr>
                    <th>模型名称</th>
                    <th>类型</th>
                    <th>特点</th>
                    <th>下载链接</th>
                </tr>
                <tr>
                    <td>SD 1.5</td>
                    <td>基础模型</td>
                    <td>最常用的基础模型，兼容性好</td>
                    <td><a href="https://huggingface.co/runwayml/stable-diffusion-v1-5" target="_blank">HuggingFace</a></td>
                </tr>
                <tr>
                    <td>SDXL 1.0</td>
                    <td>基础模型</td>
                    <td>高质量生成，细节更丰富</td>
                    <td><a href="https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0" target="_blank">HuggingFace</a></td>
                </tr>
                <tr>
                    <td>RealisticVision</td>
                    <td>风格模型</td>
                    <td>逼真的照片风格</td>
                    <td><a href="https://civitai.com/models/4201" target="_blank">Civitai</a></td>
                </tr>
                <tr>
                    <td>DreamShaper</td>
                    <td>风格模型</td>
                    <td>梦幻艺术风格</td>
                    <td><a href="https://civitai.com/models/4384" target="_blank">Civitai</a></td>
                </tr>
            </table>
        </section>

        <section id="troubleshooting">
            <h2>5. 安装常见问题</h2>
            
            <h3>5.1 Python版本问题</h3>
            <div class="note">
                <p>如果您遇到Python版本不兼容的问题，请按照以下步骤解决：</p>
                <ol>
                    <li>确保安装Python 3.10.6</li>
                    <li>删除现有的虚拟环境（删除venv文件夹）</li>
                    <li>使用Python 3.10重新创建虚拟环境</li>
                    <li>重新启动WebUI</li>
                </ol>
            </div>
            
            <h3>5.2 CUDA/PyTorch兼容性问题</h3>
            <div class="warning">
                <p>如果遇到"RuntimeError: Couldn't install torch"错误，请确保安装与您的CUDA版本兼容的PyTorch：</p>
                <ul>
                    <li>对于CUDA 12.x: <code>pip install torch==2.1.2+cu121 torchvision==0.16.2+cu121 --extra-index-url https://download.pytorch.org/whl/cu121</code></li>
                    <li>对于CUDA 11.8: <code>pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cu118</code></li>
                </ul>
            </div>
            
            <h3>5.3 权限问题</h3>
            <p>在Windows上，如果遇到权限错误，请尝试以管理员权限运行命令提示符或PowerShell。</p>
            <p>在Linux/MacOS上，如果遇到权限错误，请使用sudo或检查文件夹权限：<code>chmod -R 755 stable-diffusion-webui</code></p>
        </section>
    </main>

    <footer>
        <p>© 2024 Stable Diffusion WebUI文档 | <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui" target="_blank">官方GitHub仓库</a></p>
    </footer>
</body>
</html> 